#!/bin/bash

#check whether dnsmasq service is running
service='dnsmasq'
resolv='/var/run/dnsmasq/resolv.conf'

echo "check nameserver"
echo `cat $resolv`

/etc/init.d/$service restart

sleep 2

if (( $(ps -ef | grep -v grep | grep dnsmasq | wc -l) > 0 ))
then
echo "dnsmasq is running"
echo `cat $resolv`
else
echo "dnsmasq is NOT running"
echo `cat $resolv`
fi

#send mute to datadog when instance shutdown
api_key='{{ datadog_api_key }}'
app_key='{{ datadog_app_key }}'

mute=$(curl -X POST -H 'Content-Type: application/json' -d '{
    "message": "This instance is going to be terminated."
  }' "https://app.datadoghq.com/api/v1/host/$(hostname -f)/mute?api_key=$api_key&application_key=$app_key")

echo "$mute"
